---
layout: post
title: "State-Time League Table Visualization"
tags: [rstats, stats, data journalism, onomastics]
bibliography: ~/Literature/Bibtex/jabref.bib
comments: true
---


```{r,include=FALSE,echo=FALSE,message=FALSE}
##If default fig.path, then set it.
if (knitr::opts_chunk$get("fig.path") == "figure/") {
  knitr::opts_knit$set( base.dir = '/Users/hoehle/Sandbox/Blog/')
  knitr::opts_chunk$set(fig.path="figure/source/2017-03-05-spacetimenames/")
}
fullFigPath <- paste0(knitr::opts_knit$get("base.dir"),knitr::opts_chunk$get("fig.path"))
filePath <- "/Users/hoehle/Sandbox/Blog/figure/source/2017-03-05-spacetimenames/"

knitr::opts_chunk$set(echo = TRUE,fig.width=8,fig.height=4,fig.cap='',fig.align='center',echo=FALSE,dpi=72*2) # autodep=TRUE
options(width=90)
library("dplyr")
library("ggplot2")
library("methods")
library("magrittr")
library("tidyr")
library("readr")
library("animation")

theme_set(theme_bw())
```

## Abstract

As a final post in the 'babynames-the-data-scientists-way' series, we
use the US Social Security Administration data to space-time visualize
the most popular name for girls and boys per state in the period
1910-2015. The code uses the new simple features package (`sf`).

<center>
```{r,results='asis',echo=FALSE}
cat(paste0("![]({{ site.baseurl }}/",knitr::opts_chunk$get("fig.path"),"COLLIDEPROBTS-1.png"),")")
```
</center>

{% include license.html %}

## Introduction

This is also an opportunity to try out the new `sf` (simple features)
package. We download the social security data.

```{r,cache=TRUE, results='hide'}
#Download data
tmpfile <- paste0(tempfile(),".zip")
download.file("https://www.ssa.gov/oact/babynames/state/namesbystate.zip",destfile=tmpfile)
unzip(tmpfile,exdir=file.path(filePath,"namesbystate"))
```

Read data, which is a bunch of txt files - one for each state.
```{r,echo=TRUE}
##List all file names containing state specific data
fList <- list.files(path=file.path(filePath,"namesbystate"), pattern=".TXT")

##Read complete name list of each state
names <- purrr::map_df(fList, .f=function(f) {
  read_csv(file=file.path(filePath,"namesbystate",f), col_names=c("State","Sex","Year","Name","Count"),col_types=cols(col_character(), col_factor(c("M","F")), col_integer(), col_character(), col_integer()))
})
```

Compute top boy and girl name, respectively. Convert to easier to use wide format.
```{r,cache=TRUE, echo=TRUE}
##Find top-1 names for each state by gender. Data are already sorted.
topnames <- names %>% group_by(Year,State,Sex) %>% do({
  head(.,n=1) %>% select(Name)
}) %>% spread(Sex, Name)
```

Read US map from the R package
[`fiftystater`](https://cran.r-project.org/web/packages/fiftystater/index.html)
where Alaska and Hawaii have been re-located as map-insets as
described in its
[vignette](https://cran.r-project.org/web/packages/fiftystater/vignettes/fiftystater.html).
Furthermore, we have created a lines object containing information on
where to put the text label for a state and, if necessary, draw a line
to the centroid of the state and this location.

Load the map and the info on where to place the text. Use new `sf` package for this.
```{r, message=FALSE, results='hide',echo=TRUE}
suppressMessages(library("sf"))
usa <- st_read(file.path(filePath, "maps", "usa.shp"))
textplacement <- st_read(file.path(filePath, "maps", "lines.shp"))
```

Convert the textplacement information to a `data.frame` containing all
the coordinates. Is there a fancier way to do this for `sf` objects?
This
[post](https://geographicdatascience.com/2017/01/06/first-impressions-from-sf-the-simple-features-r-package/)
contains some the suggestion to use `lapply` to do this, but I prefer
the below more `data.frame` oriented approach. Still, I'm curious if
there is not an easier way to unwrap coordinates of each LINESTRING object?

```{r, echo=TRUE}
location <- textplacement %>% split(.$State) %>% purrr::map_df(.f = function(x) {
  pos <- st_geometry(x)[[1]]
  data.frame(State=x$State, x1.loc=pos[1,1], x2.loc=pos[1,2], x1.center=pos[2,1],x2.center=pos[2,2])
}) %>% ungroup
```

## Map augmented with Top-1 Names

```{r,echo=FALSE,results='hide',fig.keep="none"}
##Show result
usa %>% st_geometry() %>% plot
textplacement %>% st_geometry() %>% plot(add=TRUE,col="lightgray")
location %>% select(x1.center, x2.center) %>% points(pch=20,col="lightgray")
text(location %$% x1.loc, location %$% x2.loc, location$State)
```

```{r, warning=FALSE, message=FALSE, cache=TRUE, results='hide'}
##If you are unhappy about the colours, change them here
palette <- c(F="darkred",M="blue")

##Select animation range
years <- 1910:2015
##years <- 2013:2015 ; year <- 2015; state <- "HI"

saveGIF(
  for (year in years) {
    ##Make a plot, just base-graphics nothing fancy.
    par(mar=c(0,0,3.1,0))
    usa %>% st_geometry() %>% plot(border=rgb(0.8,0.8,0.8))

    ##Add lines - only proportional to size. Fancier way to do this for sf objects?
    for (state in usa$STATE_ABBR) {
      placement <- textplacement %>% filter(State==state)

      if ( (!placement %$% identical) & (placement %$%  drawLine)) {
        start <- st_geometry(placement)[[1]][2,]
        vector <-  st_geometry(placement)[[1]][1,] -  st_geometry(placement)[[1]][2,]
        if (sqrt(sum(vector^2) > 0.8)) {
          end <- start + 0.7 * vector
          lines(c(start[1],end[1]),c(start[2],end[2]),col=rgb(0.5,0.5,0.5,alpha=0.8))
        }
      }
    }

    ##Add top-1 name for each state
    textloc2 <- inner_join(location, topnames %>% filter(Year == year),by="State")
    text(textloc2 %$% x1.loc,textloc2 %$% x2.loc,textloc2 %$% M, col=palette["M"],pos=1,offset=0.2,font=1)
    text(textloc2 %$% x1.loc,textloc2 %$% x2.loc,textloc2 %$% F, col=palette["F"],pos=3,offset=0.2,font=1)

    title(paste0("Most common baby name per state in year ",year),adj=0.1,col.main=rgb(0.8,0.8,0.8),cex=1.5)
  }, movie.name="US-babynames-spacetime.gif",ani.width=720, ani.height=420, interval=0.5)
```

```{r, results='asis', echo=FALSE, warning=FALSE}
invisible(file.rename("US-babynames-spacetime.gif",file.path(fullFigPath,"US-babynames-spacetime.gif")))
cat(paste0("![]({{ site.baseurl }}/",knitr::opts_chunk$get("fig.path"),"US-babynames-spacetime.gif"),")")
```

## Cartogram augmented with Top-1 Names

We use the `Rcartogram` and `getcartr` packages to create a cartogram
for the baby names each year - see the previous
[Cartograms with R](http://staff.math.su.se/hoehle/blog/2016/10/10/cartograms.html)
post for further details.  The total number of live-births
per state in a given year is used as scaling variable for the cartograms.


```{r, warning=FALSE,message=FALSE, cache=TRUE, results='hide'}
##Install the R implementation of Cart by Gastner and Newman (2004)
devtools::install_github("omegahat/Rcartogram")
devtools::install_github('chrisbrunsdon/getcartr',subdir='getcartr')

library(Rcartogram)
library(getcartr)
library(animation)

saveGIF( {
  ##Make a cartogram
  par(mar=c(0,0,3.1,0))
  for (year in years) {
    ##Count number of births per state in that year
    oneyear <- names %>% filter(Year == year)
    aggr <- oneyear %>% group_by(State) %>% summarise(Count=sum(Count))

    ##Make Cartogram (needs sp object)
    usa_carto <- quick.carto(spdf=as(usa,"Spatial"),v=aggr$Count[pmatch(usa$STATE_ABBR,aggr$State)],res=256)

    ##Show result
    plot(usa_carto,border=rgb(0.8,0.8,0.8))

    ##Add top-1 name for each state
    location <- data.frame(State=usa_carto$STATE_ABBR, coordinates(usa_carto))
    textloc2 <- inner_join(location, topnames %>% filter(Year == year),by="State")

    text(textloc2 %$% X1,textloc2 %$% X2,textloc2 %$% M, col=palette["M"],pos=1,offset=0.2,font=1)
    text(textloc2 %$% X1,textloc2 %$% X2,textloc2 %$% F, col=palette["F"],pos=3,offset=0.2,font=1)

    title(paste0("Most common baby name per state in year ",year),adj=0.1,col.main=rgb(0.8,0.8,0.8),cex=1.5)
  }
}, movie.name="US-cartogram-babynames-spacetime.gif",ani.width=720, ani.height=420, interval=0.5)
```

```{r,results='asis',echo=FALSE, warning=FALSE}
invisible(file.rename("US-cartogram-babynames-spacetime.gif",file.path(fullFigPath,"US-cartogram-babynames-spacetime.gif")))
cat(paste0("![]({{ site.baseurl }}/",knitr::opts_chunk$get("fig.path"),"US-cartogram-babynames-spacetime.gif"),")")
```
