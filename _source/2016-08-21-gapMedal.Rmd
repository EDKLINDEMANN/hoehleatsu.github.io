---
layout: post
title: "The Olympic Medal Table Visualized in Gapminder Style"
tags: [datascience, rstats, olympic games]
bibliography: ~/Literature/Bibtex/jabref.bib
comments: true
---

```{r,include=FALSE,echo=FALSE,message=FALSE}
##If default fig.path, then set it.
if (knitr::opts_chunk$get("fig.path") == "figure/") {
  knitr::opts_knit$set( base.dir = '/Users/hoehle/Sandbox/Blog/')
  knitr::opts_chunk$set(fig.path="figure/source/2016-08-21-gapMedal/")
}
fullFigPath <- paste0(knitr::opts_knit$get("base.dir"),knitr::opts_chunk$get("fig.path"))
knitr::opts_chunk$set(echo = TRUE,fig.width=8,fig.height=5,fig.cap='')
options(width=90)
library("dplyr")
library("ggplot2")
library("tidyr")
library("rvest")
library("methods")
theme_set(theme_bw())
```

{% include license.html %}

## Abstract

Following Hans Rosling's gapminder animation style we animate a country's number
of medals won in the olympic summer games as a function of the country's [gross domestic product](https://en.wikipedia.org/wiki/Gross_domestic_product) (GDP) per capita.

# Introduction

Long Swedish winter nights are best spent by watching Hans Rosling's inspiring [TED talks](https://www.youtube.com/watch?v=hVimVzgtD6w). Such visualizations help the statistician make points about temporal trends, which otherwise might drown in modelling details.
Recently, I stumbled over a blog post on how to use the  `gganimate` R package to animate the Gapminder available from the `gapminder` package. So I got interested in trying to perform a Rosling style animation with R: Today, the olympic summer games end in Rio. As usual this spawns a debate, if the nation's participation has been successful. For this purpose the [olympic medal table](https://en.wikipedia.org/wiki/Olympic_medal_table) is preferably taken as basis for comparisons. Recent analyses have been interested in how to correct these tables for, e.g., population size or, more interesting, analyse the influence of GDP.

Aim of this blog note is to visualize how countries develop in the medal table while setting this in relation to their GDP. From a technical viewpoint we use R to scrape the olympic medal tables from Wikipedia and animate the results Gapminder style. **Disclaimer**: We only show the potential of such an analysis and, hence, worry less about the scientific validity of the analysis. 

# Data

We use the data of [Gapminder](https://www.gapminder.org/) in order to obtain country specific population and GDP data for each of the years 1960-2012. These are based on data from the World Bank. The olympic medal tables are harvested from Wikipedia.

## Olympic medal tables

Olympic medal tables were extracted using the `rvest` package from Wikipedia pages using the post by [Cory Nissen](http://blog.corynissen.com/2015/01/using-rvest-to-scrape-html-table.html). These data contain the current state and takes  changes after the games, e.g. due to doping, partly into account. For details see for example the [medal table of the 2012 summer games](https://en.wikipedia.org/wiki/2012_Summer_Olympics_medal_table) in London. The scraping functionality is hidden in the function `scrape_medaltab` - see the code on GitHub for details.

```{r,SCRAPE,echo=FALSE}
#Base URL of the wikipedia pages
base_url <- "https://en.wikipedia.org/wiki/1960_Summer_Olympics_medal_table"

# Scrape medal table of one particular olympic summer game
scrape_medaltab <- function(year) {
  tableNumber <- ifelse(year %in% c(1960,1984,1992,1996,2000,2004,2008,2012), 2,1) #table number depends on year
  medals <- gsub("1960",year,base_url) %>%
    read_html() %>%
    html_nodes(xpath=paste0("//*[@id=\"mw-content-text\"]/table[",tableNumber,"]")) %>%
    html_table(fill=TRUE) #%>% .[[1]]
  medals <- medals[[1]]
  #Sometimes the nation is called NOC, and "Rank" is also " Rank " once
  names(medals) <- gsub("NOC","Nation",names(medals))
  names(medals) <- gsub("\\sRank\\s","Rank",names(medals))

  #Remove total row
  medals <- medals %>% filter(row_number() < nrow(medals))

  # Massage country names
  medals <- medals %>% mutate(Nation = gsub("\\*", "", Nation)) #host nation
  medals <- medals %>% mutate(Nation = gsub("â€¡", "", Nation))   #changes in medals
  medals <- medals %>% mutate(Nation = gsub("^\\s", "", Nation))

  medals <- medals %>% mutate(Nation = gsub("\\([A-Z\\s]+\\)$", "", Nation))
  medals <- medals %>% mutate(Nation = gsub("\\s$", "", Nation))

  return(cbind(Year=year,medals))
}
```

```{r}
#Years which had olympic games
olympic_years <- seq(1960, 2012, by=4)

# Extra olympic medal table from all olympic years since 1960
medals <- bind_rows(lapply(olympic_years, scrape_medaltab))

# Show result
DT::datatable(medals)
```

## Gapminder data

We obtain GDP per capita and population data from [Gapminder](https://www.gapminder.org/data/). Unfortunately, these need to be fetched and merged manually. A more convenient way would have been to take these directly from the package [`gapminder`](https://cran.r-project.org/web/packages/gapminder/index.html), but the population is here only available for the years with GDP data and not, as in the original source data, for all years. For simplicity, we hide this data munging code and refer to the underlying code on GitHub for the details.

```{r,echo=FALSE, warning=FALSE}
##Library to read excel files
library("openxlsx")

# Obtain GDP/capita data from
# https://www.gapminder.org/data/ -- this is is the file
# Old version of Income per person (version 8)
# From the file: 	Gross Domestic Product per capita by Purchasing
# Power Parities (in international dollars, fixed 2005 prices).
# The inflation and differences in the cost of living between
# countries has been taken into account.
if (!file.exists("../downloads/indicator_gdp_per_capita_ppp_version8.xlsx")) {
   download.file(url="https://spreadsheets.google.com/pub?key=0ArfEDsV3bBwCdE5xWmcyYVZJQzJvOFpZUklqX3lkSkE&output=xls",destfile="../downloads/indicator_gdp_per_capita_ppp_version8.xlsx")
}

gdp <- read.xlsx("../downloads/indicator_gdp_per_capita_ppp_version8.xlsx")
names(gdp) <- gsub("\\.0$","",names(gdp))
names(gdp)[1] <- c("Nation")

#Reshaping from wide format to long format
gdp_long <- gdp %>% gather(Year, GDPpc, -Nation)
gdp_long <- gdp_long %>% mutate(Year=as.numeric(Year)) %>% filter(Year >= 1950 & !is.na(GDPpc))

#Impute GDP per capita for each country using spline interpolation
nations <- gdp_long  %>% select(Nation)  %>% distinct() %>% unlist

#Function to interpolate GDP per capita for the olympic years
#based on the gapminder data.
interp_country <- function(country) {
  nationData <- gdp_long %>% filter(Nation == country)
  f <- splinefun(x=nationData$Year, y=nationData$GDPpc,method="natural")
  interp_data <- data.frame(Nation=as.character(country), Year=olympic_years, GDPpc= f(olympic_years))
  return(interp_data)
}

#Interpolate GDP for all countries
gdp_long_interp <- bind_rows( lapply(nations, interp_country))

if (!file.exists("../downloads/gapminder_population.xlsx")) {
  download.file(url="https://spreadsheets.google.com/pub?key=phAwcNAVuyj0XOoBL_n5tAQ&output=xls",destfile="../downloads/gapminder_population.xlsx")
}
pop <- read.xlsx("../downloads/gapminder_population.xlsx")
names(pop) <- gsub("\\.0","",names(pop))
names(pop)[1] <- c("Nation")
pop_long <- pop %>% gather(Year, Population, -Nation)
pop_long <- pop_long %>% mutate(Year=as.numeric(Year))

#All this is part of the gapminder package, but unfortunately with uneven recordings
gapminder_manual <- inner_join(gdp_long_interp, pop_long, by=c("Nation","Year"))
```

For convenience, we also extract the corresponding continent each country belongs to. This can be done conveniently by comparing with the `gapminder` dataset (see code for details).

```{r,echo=FALSE,warning=FALSE}
#Fetch continent from gapminder package
library("gapminder")
data("gapminder_unfiltered")
gapminder_continent <- gapminder_unfiltered %>% rename(Continent = continent, Nation = country) %>% select(Nation,Continent) %>% distinct
gapminder_manual <- left_join(gapminder_manual, gapminder_continent, by=c("Nation"))
```

```{r,eval=FALSE,echo=FALSE,warning=FALSE}
library("gapminder")
data("gapminder_unfiltered")
#Rename column so they match the olympic medal table
gapminder <- rename(gapminder_unfiltered, Continent = continent, Nation = country, Year = year, GDPpc = gdpPercap, Population = pop)
#Data for 2012 is missing, we just copy 2011 data and pretend its 2012
gapminder <- gapminder %>% bind_rows(
  gapminder  %>% filter(Year == "2011") %>% mutate(Year = 2012))
```

## Joining the two data sources

In principle all that is left to do is to join the two data sources using the names of the gapminder dataset and the nation names of the olympic medal tables. However, this would ignore the fact that there is a discrepancy between the national olympic committees sending the athletes and the countries for which we have GDP information.

A further challenge of the present country based analysis is how to incorporate the many political changes which happened during that period. As an example, East Germany participated as independent national olympic committee during 1968-1988, but the gapminder data only contain GDP data for Germany as a total. A further important change is the split of the former Soviet Union into several independent states. As a consequence, in 1992 the former Soviet republics participated as [Unified Team](https://en.wikipedia.org/wiki/Unified_Team_at_the_1992_Summer_Olympics). We skip the details of these many data munging details and simply refer to the GitHub code for details.

```{r,echo=FALSE}
medals_mod <- medals %>% select(Nation,Year,Gold,Silver, Bronze,Total)

#Merge Germany into one country? Is there a better way to do
#this in dplyr?
germany <- medals_mod %>% group_by(Year) %>% filter(grepl("Germany",Nation)) %>%  summarise_each(funs(sum),-Nation) %>% mutate(Nation="Germany")

medals_mod <- medals_mod %>% filter(!grepl("Germany",Nation)) %>% bind_rows(germany) %>% arrange(Year,desc(Gold))

#Rename Great Britain in the medal dataset to United Kingdom
medals_mod <- medals_mod %>% mutate(Nation = replace(Nation, Nation=="Great Britain", "United Kingdom"))

#Rename the Unified Team in 1992 to Soviet union even though
#countries such as Estonia, Latvia and Lithuania already in 1992
#competed as independent countries
medals_mod <- medals_mod %>% mutate(Nation = replace(Nation, Nation=="Unified Team", "Soviet Union") )

# The gapminder data contain no information on the Soviet Union,
# but the countries making up the former soviet Union are present
# we hence create an artificial Soviet Union GDP based on the
# info in https://en.wikipedia.org/wiki/Soviet_Union
soviet_republics <- c("Russia", "Armenia", "Azerbaijan", 	"Belarus", 	"Estonia", 	"Georgia", 	"Kazakhstan", "Kyrgyzstan", 	"Latvia", "Lithuania", 	"Moldova", 	"Tajikistan", "Turkmenistan", "Ukraine","Uzbekistan")

soviet_union <- gapminder_manual %>% group_by(Year) %>%  filter((Nation %in% soviet_republics & Year < 1992) | (Nation %in% setdiff(soviet_republics, c("Estonia","Latvia","Lithuania")) & Year == 1992)) %>% summarise(GDPpc=mean(GDPpc), Population=sum(Population)) %>% mutate(Nation = "Soviet Union", Continent="FSU")

#Handle Yugoslavia
yugo_republics <- c("Croatia", "Bosnia-Herzegovina", "Slovenia", "Serbia", "Macedonia", "Montenegro", "Bosnia and Herzegovina")

yugoslavia <- gapminder_manual %>% group_by(Year) %>%  filter((Nation %in% yugo_republics & Year < 1992) | (Nation %in% setdiff(yugo_republics, c("Croatia", "Bosnia-Herzegovina", "Slovenia")) & Year == 1992)) %>% summarise(GDPpc=mean(GDPpc), Population=sum(Population)) %>% mutate(Nation = "Yugoslavia", Continent="Europe")

#Update the gapminder dataset
gapminder_manual <- bind_rows(gapminder_manual, soviet_union, yugoslavia)

```

```{r,warning=FALSE}
medals_gm <- left_join(medals_mod, gapminder_manual, by=c("Nation","Year"))
```

# Results

First we analyse the [all-time summer olympic medal table](https://en.wikipedia.org/wiki/All-time_Olympic_Games_medal_table) for the period 1960-2012.

```{r}
medals_alltime <- medals_gm  %>% group_by(Nation)  %>% summarise(Total=sum(Total))  %>% arrange(desc(Total))
DT::datatable(medals_alltime)
```

We now plot of the total number of medals awarded for each summer games in the period of 1960-2012.
```{r}
nTotal <- medals_gm %>% group_by(Year) %>% summarise(TotalOfGames=sum(Total))
ggplot(nTotal, aes(x=Year,y=TotalOfGames)) + geom_line() + ylab("Total number of medals")
```

We observe a clear trend. Hence, in order to make between country comparisons over time based on the number of medals won, we normalize the numbers of medal won using the total number of medals awarded during the  games. We store this result in the column `Frac`.

```{r}
medals_gm <- medals_gm %>% left_join(nTotal, by="Year") %>% mutate(Frac = Total / TotalOfGames)
```

We now look at the country results for each summer games starting from 1996.

```{r,echo=FALSE,warning=FALSE}
#Add city name for better visualization
olympic_city <- data.frame(Year=olympic_years, City=c("Rome","Tokyo", "Mexico City","Munich", "Montreal", "Moscow","Los Angeles", "Seoul", "Barcelona", "Atlanta", "Sydney", "Athens", "Beijing", "London"))

medals_gm <- left_join(medals_gm, olympic_city, by="Year") %>% mutate("YearCity"=paste0(Year," - ",City))


medals_gm1996 <- medals_gm %>% filter(Year >= 1996)
p1 <- ggplot(medals_gm1996,
             aes(x=GDPpc, y=Frac, size = Population, colour= Continent)) +
             geom_point() +
    geom_text(data=medals_gm1996, aes(x=GDPpc, y=Frac, label=Nation), vjust=-1,show.legend=FALSE) +
             scale_x_log10() + xlab("GDP per Capita") + ylab("Fraction of All Medals") +
  scale_y_continuous(labels = scales::percent)
p1 + facet_grid(. ~ YearCity)
```

Finally, we can use the `gganimate` package to visualize the dependence of the total number of medals won in the summer games 1960-2012 as a function of GDP per capita. See the [package documentation](https://github.com/dgrtwo/gganimate) for details.

```{r,GAPMINDERANIM,fig.width=8,fig.height=5,echo=FALSE,warning=FALSE,results='hide',message=FALSE,fig.keep='hide'}
p2 <- ggplot(medals_gm, aes(x=GDPpc, y=Frac, size = Population, color = Continent, frame = YearCity)) +
  geom_point() +
  geom_text(data=medals_gm, aes(x=GDPpc, y=Frac, label=Nation), vjust=-1,show.legend=FALSE) +
  scale_x_log10() +
  xlab("GDP per Capita") + ylab("Fraction of All Medals") +
  scale_y_continuous(labels = scales::percent)
#Animate the result
#gganimate::gg_animate(p2,interval = 2, ani.width=480, ani.height=480)
gganimate::gg_animate(p2, filename="olympicMedals-gapminder-style.gif",interval = 2)
#, ani.width=480, ani.height=480)
```

```{r,results='asis',echo=FALSE}
invisible(file.rename("olympicMedals-gapminder-style.gif",file.path(fullFigPath,"olympicMedals-gapminder-style.gif")))
cat(paste0("![]({{ site.baseurl }}/",knitr::opts_chunk$get("fig.path"),"olympicMedals-gapminder-style.gif"),")")
```

It is worth noticing that China, due to protests against the participation of Taiwan, did not participate in the Olympics 1956-1980. 


# References
