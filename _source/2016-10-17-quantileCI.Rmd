---
layout: post
title: "Confidence Intervals for Population Quantiles with R"
tags: [dataviz, rstats, stats]
bibliography: ~/Literature/Bibtex/jabref.bib
comments: true
---

```{r,include=FALSE,echo=FALSE,message=FALSE}
##If default fig.path, then set it.
if (knitr::opts_chunk$get("fig.path") == "figure/") {
  knitr::opts_knit$set( base.dir = '/Users/hoehle/Sandbox/Blog/')
  knitr::opts_chunk$set(fig.path="figure/source/2016-10-17-quantileCI/")
}
fullFigPath <- paste0(knitr::opts_knit$get("base.dir"),knitr::opts_chunk$get("fig.path"))
filePath <- "/Users/hoehle/Sandbox/Blog/figure/source/2016-10-17-quantileCI/"

knitr::opts_chunk$set(echo = TRUE,fig.width=8,fig.height=5,fig.cap='')
options(width=90)
library("dplyr")
library("ggplot2")
library("tidyr")
library("methods")
theme_set(theme_bw())
```

## Abstract

R code is provided to compute confidence intervals for the median or any other quantile based on the suggestions by @hettmansperger_sheather1986 and @nyblom199X. These intervals are computed such that they have a good coverage even in the small sample setting. 


```{r,results='asis',echo=FALSE}
cat(paste0("![]({{ site.baseurl }}/",knitr::opts_chunk$get("fig.path"),"CARTOGRAM-1.png"),")")
```

{% include license.html %}

## Introduction

Statistics 101 tells that for a distribution, possibly contaminated with outliers, a robust measure of the central tendency is the median. Not knowing this fact can even make your analysis worthy to report in the [newspaper](http://www.sueddeutsche.de/wirtschaft/heilbronn-dieser-mann-ist-so-reich-dass-statistiken-seines-wohnorts-wertlos-sind-1.2705044) (link in German). 

Quantiles of a distribution also have a long history for when to declare an observation an outlier. For example, growth curves for children show how the quantiles of, e.g., [the BMI distribution develops by age](http://www.cdc.gov/growthcharts/data/set1clinical/cj41l024.pdf). Obesity in children is then defined as, e.g., exceedance of the [97.7% quantile](http://www.who.int/growthref/bmifa_girls_z_5_19_labels.pdf?ua=1). Quantile regression is a non-parametric method to compute such curves and the statistical community has been very busy lately in investigating new ways to compute such regressions and adequately handle uncertainty in this context.

However, the focus of this blog post is the simple setting: Given an iid. sample $x$ of size $n$ from the univariate and absolutely continuous distribution $F$, how does one compute an estimate for the $p$-Quantile of $F$ together with an associated confidence interval? 

### The Point Estimate

How to compute the point-estimate using statistical software packages is discussed in the excellent survey of @hyndman_fan1996. It is interesting to notice that [20 years after](http://robjhyndman.com/hyndsight/sample-quantiles-20-years-later/), there still appears to be a multitude of ways to compute quantiles and the `type` argument has been a friend when comparing results with SPSS or Stata users. The simplest estimator is based on the [order statistic](https://en.wikipedia.org/wiki/Order_statistic) $x_{(1)} < x_{(2)} < \cdots < x_{(n)}$ of $x$.
$$
x_p = \min_{k} \left\{\hat{F}(x_{(k)}) \geq p\right\},
$$
where $\hat{F}$ is the (empirical distribution)[https://en.wikipedia.org/wiki/Empirical_distribution_function] function of the sample. Since $\hat{F}$ has jumps of size $1/n$ the actual value of $\hat{F}(x_{(k)})$ can actually be somewhat larger than the desired $p$. Therefore, 
 @hyndman_fan1996 prefers estimators interpolating between the two values of the order statistic with $\hat{F}$ just below and just above $p$. In what follows we will, however, stick with this simple procedure.



```{r}
##Make a tiny artificial dataset.
set.seed(as.integer(charToRaw("R")))
##z-score of 25 artifical children
x <- rnorm(25)

##Define the quantile we want to consider
p <- 0.8
##Since we know the true distribution we can easily find the true quantile
(x_p <- qnorm(p))
```
We can now compute an estimate for the $p$-quantile in the population
```{r}
quantile(x, type=3, prob=p)
```

### Confidence interval for the quantile

When it comes to confidence intervals for quantiles the set of alternatives is less extensive in R. Searching for this on CRAN,  I found the following:

* [`MKMisc::quantileCI`](http://finzi.psych.upenn.edu/R/library/MKmisc/html/quantileCI.html) implements and exact but very slow $O(n^2)$ search as well as an asymptotic method
* the exact binomial method in [`jmuOutlier::quantileCI`](http://finzi.psych.upenn.edu/R/library/jmuOutlier/html/quantileCI.html) 
* the [`envStats::eqnpar`] function, which also computes the exact as well as the asymptotic method
* the $Qtools::confint.midquantile` (which I don't understand). 

The easy solution isto use the ordinary bootstrap to compute a confidence interval for the quantile:

```{r}
as.numeric(MKmisc::quantileCI(x=x, prob=p, method="exact",conf.level=0.95)$CI)
as.numeric(MKmisc::quantileCI(x=x, prob=p, method="asymptotic",conf.level=0.95)$CI)
as.numeric(jmuOutlier::quantileCI(x=x, probs=p, conf.level=0.95)[1,c("lower","upper")])
as.numeric(EnvStats::eqnpar(x=x, p=p, ci=TRUE, ci.method="exact",approx.conf.level=0.95)$interval$limits)
as.numeric(EnvStats::eqnpar(x=x, p=p, ci=TRUE, ci.method="normal.approx",approx.conf.level=0.95)$interval$limits)

quantile_confint_boot <- function(x, p, conf.level=0.95, R=999) {
  b <- boot::boot(x, statistic=function(data, idx) quantile(x[idx],prob=q,type=3), R=R)
  boot::boot.ci(b, conf=conf.level, type="perc")$percent[4:5]
}

quantile_confint_boot(x, p=p, conf.level=0.95,R=999)
```

Lot's of suggestions. Here is my own take at this:

```{r,eval=FALSE}
devtools::install_github("hoehleatsu/quantileCI")
```

```{r}
quantileCI::quantile_confint_nyblom(x=x, p=p, conf.level=0.95,interpolate=FALSE)
quantileCI::quantile_confint_nyblom(x=x, p=p, conf.level=0.95,interpolate=TRUE)
```

## Small Simulation Study to Determine Coverage

```{r}
##Function to compare the different methods. quantile_confint3 is different in many cases!
quantile_confints <- function(x, p, conf.level, x_is_sorted=FALSE) {
  if (!x_is_sorted) { x <- sort(x)}

  res <- data.frame(jmuOutlier_exact=as.numeric(jmuOutlier::quantileCI(x=x, probs=p, conf.level=conf.level)[1,c("lower","upper")]),
                    EnvStats_Exact=as.numeric(EnvStats::eqnpar(x=x, p=p, ci=TRUE, ci.method="exact",approx.conf.level=conf.level)$interval$limits),
                    EnvStats_Asymptotic=as.numeric(EnvStats::eqnpar(x=x, p=p, ci=TRUE, ci.method="normal.approx",approx.conf.level=0.95)$interval$limits),
                    nyblom_exact=quantileCI::quantile_confint_nyblom(x=x, p=p, conf.level=conf.level,x_is_sorted=TRUE,interpolate=FALSE),
                    nyblom=quantileCI::quantile_confint_nyblom(x=x, p=p, conf.level=conf.level,x_is_sorted=TRUE,interpolate=TRUE),
                    boot=quantile_confint_boot(x, p=p, conf.level=conf.level,R=999)
                    )
  return(res)
}
```

```{r}
quantile_confints(x, p=p, conf.level=0.95)
```

```{r,SIMSTUDY,cache=TRUE}
######################################################################
## Simulation study with all methods
######################################################################
one_sim <- function(n, rfunc=rnorm, qfunc=qnorm, p=0.5, conf.level=0.95) {
  ##Draw the sample and check the truth
  x <- sort(rfunc(n))
  truth <- qfunc(p)

  ##Compute confidence intervals for all methods
  cis <- quantile_confints(x=x, p=p, conf.level=conf.level, x_is_sorted=TRUE)

  ##Check if intervals cover the true value
  covers <- (cis[1,] <= truth) & (cis[2,] >= truth)
  covers
}

y <- pbapply::pbreplicate(1e3,one_sim(n=25,p=0.8,conf.level=0.95))
apply(y,c(1,2),mean)

```


# Outlook

While writing this posts some other useRs have posted on how to create
[interactive cartograms](https://twitter.com/Victpir/status/785852075129315333).

# References


