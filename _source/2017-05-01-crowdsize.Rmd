---
layout: post
title: "Estimating the Size of a Demonstration"
tags: [rstats, stats, data journalism]
bibliography: ~/Literature/Bibtex/jabref.bib
comments: true
---


```{r,include=FALSE,echo=FALSE,message=FALSE}
##If default fig.path, then set it.
if (knitr::opts_chunk$get("fig.path") == "figure/") {
  knitr::opts_knit$set( base.dir = '/Users/hoehle/Sandbox/Blog/')
  knitr::opts_chunk$set(fig.path="figure/source/2017-05-01-crowdsize/")
}
fullFigPath <- paste0(knitr::opts_knit$get("base.dir"),knitr::opts_chunk$get("fig.path"))
filePath <- file.path("/","Users","hoehle","Sandbox", "Blog", "figure", "source", "2017-05-01-crowdsize")

knitr::opts_chunk$set(echo = TRUE,fig.width=8,fig.height=4,fig.cap='',fig.align='center',echo=FALSE,dpi=72*2) # autodep=TRUE
options(width=90)

suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(magrittr))

theme_set(theme_bw())
```

## Abstract

Inspired by the recent **March For Science** we look into methods for
the statistical estimation of the number of people participating in a
demonstration organized as a march.  In particular, we provide data
and R code to reproduce the **two on-the-spot counting method**
analysis of @yip_etal2010 for the July 1 Marches in Hong Kong.

<center>
```{r,results='asis',echo=FALSE,fig.cap="July 1 Marches in 2006, Hong Kong"}
cat(paste0("![](https://upload.wikimedia.org/wikipedia/commons/thumb/c/c0/Hong_Kong_July_1_Marches.jpg/640px-Hong_Kong_July_1_Marches.jpg)"))
```
</center>

{% include license.html %}

## Introduction

With the poles of politics drifting apart, exercising your
constitutional and democratic right to express support for a cause by
demonstration has found renewed usage.  The
[March for Science](https://en.wikipedia.org/wiki/March_for_Science)
or the
[People's Climate March](https://en.wikipedia.org/wiki/People%27s_Climate_March_(2017))
are just recent examples of such demonstrations in the form of Marches
inspired by recent political developments. The number of persons
participating in such marches is *the* indicator by which the support
of the cause is measured. Hence, crowd size estimates have always been
subject to political interpretation and, hence, possible politically
motivated bias. In this work we focus on what statistics has to offer
with respect to finding the **true number** of participants.

As case study we replicate the analysis of @yip2010 concerned with the
crowdsize estimation of the
[1st of July Marches](https://en.wikipedia.org/wiki/Hong_Kong_1_July_marches#2006)
in Hong Kong 2006. These 1st of July demonstrations have become an
increasingly (both in size but also importance) way of
demonstrating...  Below is shown the 3.6 km long demonstration route
from Victoria Park to Government Headquarters as described by
@yip_etal2010. A
[youtube video](https://www.youtube.com/watch?v=8WQ2TAEquxM) of the
2006 demonstration illustrates the above.

<center>
```{r,results='asis',echo=FALSE}
cat(paste0("![Route of the 1st of July 2006 demonstration in Hong Kong. The two points A and B indicate the location of the two counting points. Courtesy goes to Open Street Map.]({{ site.baseurl }}/",knitr::opts_chunk$get("fig.path"),"Route.png"),")")
```
</center>


### Loading the Data

We store the data displayed in Table 2 (Point A) and Table 3 (Point B)
of @yip_etal2010 as two Excel-Files, which are read and combined into
one dataframe both containing the columns `Y1`-`Y4`. Furthermore, we
re-format the table's time specification to proper POSIX formatted
date-times. Altogether, this yields a `tbl` with the first couple of
lines looking as follows:

```{r, message=FALSE}
##Read data
pA <- readxl::read_excel(path=file.path(filePath,"pointA.xlsx")) %>% mutate(Point="A")
pB <- readxl::read_excel(path=file.path(filePath,"pointB.xlsx")) %>% mutate(Point="B", Y4=NA)

##Join into one data frame and make time into POSIX
counts <- rbind(pA, pB) %>% mutate(Time_POSIX= as.POSIXct(paste0("2006-07-01 ",Time,":00"),tz="Hongkong") + 12*3600)
head(counts)
```

We then compute a number of row-wise statistics for the up to four
observations per time point. Instead of performing these computations
manually we use the `matrixStats` package for this.

```{r}
##Regular expression for specification of the column names containing the counts
ccol_spec <- "^Y[0-9]+"

##Note: matrixStats package function (e.g. rowVars) requires a matrix
suppressPackageStartupMessages(require(matrixStats))
counts <- counts %>% mutate(Mean = rowMeans(select(., matches(ccol_spec)), na.rm = TRUE),
                 VarY = rowVars(as.matrix(select(., matches(ccol_spec))), na.rm = TRUE),
                 m = rowCounts(!is.na(select(., matches(ccol_spec)))),
                 se2Mean=VarY/m)
```

### Descriptive Statistics

```{r,warning=FALSE}
##Convert to long format
counts_long <- tidyr::gather(counts %>% select(Time_POSIX, Y1,Y2,Y3,Y4,Point), Where, Counts, -Time_POSIX, -Point)

##Make two illustrations
ggplot(counts, aes(x=Time_POSIX, y=Mean, colour=Point)) + geom_line() + xlab("Time") + ylab("Mean of Counts") + geom_point(data=counts_long, aes(x=Time_POSIX, y=Counts)) + facet_wrap(~Point)
```

## Estimating the Size of the Demo

**two on-the-spot counting method**

Consider the counting at a particular point $X$ of the March. Let
$m_X$ be the number of counters at this point. Assume that the
beginning of the march passes $X$ at time point 1 and that the end of
the march reaches $X$ at time point $\tau_X$ (measured for example in
minutes). Assume the counting is such that regular interval $c$ one
count for a time block of 1 unit. Hence, observations are available
for the time points $a_X,a_X+c,a_X+2c,\ldots$. Denote by $Y_{X,j}(t)$
the count for period $t$ of the $j$'th counter and let
$\overline{Y}_X(t) = \sum_{i=1}^{k_X} Y_{X,j}(t)/m_X$ and
$\widehat{\operatorname{Var}}(Y(t)) = \sum_{i=1}^{k_X} (Y_{X,j}(t) -
\overline{Y}_X(t))^2 /(m_X-1)$ denote the average and variance of the
observer's counts at time $t$.



$$
\hat{N}_X = \frac{\tau_X}{k_X} \sum_{j=1}^{k_X} \overline{Y}_X(a_X +
(j-1)c), \quad X=\{A,B\}
$$

$$
\widehat{\operatorname{Var}}(\hat{N}_X) =
\frac{\tau_X^2}{k_X^2} \sum_{j=1}^{k_X}
\widehat{\operatorname{Var}}(\overline{Y}_X(a_X + (j-1)c)) =
\frac{\tau_X^2}{k_X^2} \sum_{j=1}^{k_X}
\frac{\widehat{\operatorname{Var}}(Y_X(a_X + (j-1)c))}{m_X}
$$

$$
\hat{N} = \hat{N}_A + (1-\hat{\phi}) \hat{N}_B.
$$

$$
\operatorname{se}(\hat{N}) =
\sqrt{\widehat{\operatorname{Var}}(\hat{N}_A) + (1-\hat{\phi})^2
\widehat{\operatorname{Var}}(\hat{N}_B) + \hat{N}_B^2 \frac{\hat{\phi}(1-\hat{\phi})}{m}}.
$$


```{r}
######################################################################
## Function to obtain the two-on-the-spot estimate by Yip et
## al. (2010) for the size of a demonstraion.
##
## Parameters:
##
## @paramcounts A data.frame containing columns Point, Mean, Var
##
## @param phi_estim A vector of length two containing numerator and
## denominator of the survey on how many of the participants asked at
## point B report also having been at point A.
## @param c
## @param conf.level Confidence level for the returned confidence interval
######################################################################


two_on_the_spot_N <- function(counts, phi_estim, c=5, conf.level=0.95) {
  ##Check that the necessary names are present in the data.frame
  stopifnot(isTRUE(all(!is.na(pmatch(c("Point","Mean","VarY"), names(counts))))))
  stopifnot(isTRUE(all(!is.na(pmatch(c("A","B"), counts$Point)))))

  xN <- counts %>% group_by(Point) %>% do({
    ##How many observations in total
    k_X <- nrow(.)
    ##An observation is made each c epochs:
    c <- 5
    ##Total number of epochs covered. Assumption: Last observation is also extrapolated to become equivalent to c epochs
    tau_X <- 1+(k_X-1)*c + (c-1)
    ##Compute estimate and its standard error
    Nhat_X <- tau_X / k_X * summarise(., sum(Mean))
    se2_Nhat_X <- tau_X^2 / k_X^2 * summarise(., sum(VarY/m))
    ##Return result
    data.frame(Nhat_X=as.numeric(Nhat_X),se2_Nhat_X=as.numeric(se2_Nhat_X))
  })


  ##Compute the estimate
  m <- phi_estim[2]
  phi.hat <- phi_estim[1]/phi_estim[2]

  N_hat <- (N %>% filter(Point=="A") %$% Nhat_X) + (1-phi.hat) * (N %>% filter(Point=="B") %$% Nhat_X)
  ##Standard error
  se_N_hat <- sqrt( (N %>% filter(Point=="A") %$% se2_Nhat_X) +
                    (1-phi.hat)^2 * (N %>% filter(Point=="B") %$% se2_Nhat_X) +
                    (N %>% filter(Point=="B") %$% Nhat_X * phi.hat*(1-phi.hat)/m))

  ##95% Confidence interval based on asymptotic normal
  ci <- N_hat + c(ci_lower=-1,ci_upper=1)*qnorm(1-(1-conf.level)/2)* as.numeric( se_N_hat)

  return(list(estimate=N_hat, ci=ci, N=N, se_N_hat=se_N_hat))
}

##Proportions
N <- two_on_the_spot_N(counts, phi_estim=c(437,480))

##Rounded version
with(N, round(c(estimate=estimate,ci)/100)*100)
```

## Discussion


[Critical Mass](https://en.wikipedia.org/wiki/Critical_Mass_(cycling))

QED.

![](https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Hong_Kong_1_July_march.jpg/640px-Hong_Kong_1_July_march.jpg)
<br>
[Picture Source](https://en.wikipedia.org/wiki/File:Hong_Kong_1_July_march.jpg):
Ding Yuin Shan, Hong Kong, licensed under the Creative Commons Attribution 2.0 Generic
license.



## References

